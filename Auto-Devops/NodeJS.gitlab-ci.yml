

.nodejs_present_rule: &nodejs_present_rule
  exists:
    - package.json

variables:
  # Relative NPM cache path
  CI_NPM_CACHE_FOLDER: '.cache/npm'
  # Relative Cypress cache path
  CI_CYPRESS_CACHE_FOLDER: '.cache/cypress'
  # Display less npm message
  npm_config_loglevel: warn
  # NPM cache environment variable
  npm_config_cache: "$CI_PROJECT_DIR/$CI_NPM_CACHE_FOLDER"
  # Cypress cache environment variable
  CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/$CI_CYPRESS_CACHE_FOLDER"

install_nodejs:
  stage: prepare
  rules:
    - <<: *nodejs_present_rule
  script:
    - exit 0

build_nodejs:
  stage: build
  script:
    - npm run build --if-present
  needs:
    - job: install_nodejs
      artifacts: true
  artifacts:
    paths:
      - dist/
      - lib/
      - packages/*/lib/
      - packages/*/dist/
  rules:
    - <<: *nodejs_present_rule

lint_nodejs:
  stage: test
  needs:
    - job: build_nodejs
      artifacts: true
  tags:
    - lightweight-job
  script:
    - npm run lint --if-present
  rules:
    - <<: *nodejs_present_rule

test_nodejs:
  stage: test
  needs:
    - job: build_nodejs
      artifacts: true
  tags:
    - lightweight-job
  script:
    - npm test --if-present
  rules:
    - <<: *nodejs_present_rule

test_e2e_nodejs:
  stage: test
  needs:
    - job: build_nodejs
      artifacts: true
  tags:
    - heavy-job
  script:
    - npm run test:e2e --if-present
  rules:
    - <<: *nodejs_present_rule
