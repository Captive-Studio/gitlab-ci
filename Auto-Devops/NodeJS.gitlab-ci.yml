.nodejs_rules:
  rules:
    - &skip_code_quality_disabled
      if: $CODE_QUALITY_ENABLED == null || $CODE_QUALITY_ENABLED == ''
      when: never
    - &skip_test_disabled
      if: $TEST_ENABLED == null || $TEST_ENABLED == ''
      when: never
    - &skip_test_system_disabled
      if: $TEST_SYSTEM_ENABLED == null || $TEST_SYSTEM_ENABLED == ''
      when: never
    - &skip_if_makefile
      exists:
        - Makefile
      when: never
    - &nodejs_present_rule
      exists:
        - package.json

.nodejs_cache:
  cache:
    - &nodejs_cache
      key: ${CI_PIPELINE_ID}-node-install
      paths:
        - ${CI_CYPRESS_CACHE_FOLDER}
        - '**/node_modules/'
      policy: pull

variables:
  # Relative NPM cache path
  CI_NPM_CACHE_FOLDER: .cache/npm
  # Relative NPM cache path
  CI_YARN_CACHE_FOLDER: .yarn/cache
  # Relative Cypress cache path
  CI_CYPRESS_CACHE_FOLDER: .cache/cypress
  # Display less npm message
  npm_config_loglevel: warn
  # NPM cache environment variable
  npm_config_cache: $CI_PROJECT_DIR/$CI_NPM_CACHE_FOLDER
  # Cypress cache environment variable
  CYPRESS_CACHE_FOLDER: $CI_PROJECT_DIR/$CI_CYPRESS_CACHE_FOLDER
  # Cypress cache environment variable
  YARN_CACHE_FOLDER: $CI_PROJECT_DIR/$CI_YARN_CACHE_FOLDER

nodejs:install:
  extends:
    - .nodejs_image
    - .gitlab_fast_zip
  stage: prepare
  cache:
    - key: ${CI_COMMIT_REF_SLUG}-package-cache
      # must be inside $CI_PROJECT_DIR for gitlab-runner caching (#3)
      paths:
        - ${CI_NPM_CACHE_FOLDER}
        - ${CI_YARN_CACHE_FOLDER}
      when: on_success
      policy: pull-push
    - <<: *nodejs_cache
      policy: push
  script:
    - |
      # Case Yarn Berry
      if [[ -f yarn.lock && -d .yarn/releases ]]; then
        yarn install --immutable;

      # Case Yarn Classic
      elif [[ -f yarn.lock && ! -d .yarn/releases ]]; then
        yarn install --frozen-file --prefer-offline;

      # Case NPM
      else
        npm ci --prefer-offline --no-audit --no-optional;
      fi;
  rules:
    - <<: *skip_if_makefile
    - <<: *nodejs_present_rule

nodejs:build:
  extends:
    - .nodejs_image
    - .nodejs_cache
  stage: build
  script:
    - npm run build --if-present
  needs:
    - job: nodejs:install
      artifacts: true
  artifacts:
    paths:
      - dist/
      - lib/
      - packages/*/lib/
      - packages/*/dist/
  rules:
    - <<: *skip_if_makefile
    - <<: *nodejs_present_rule

nodejs:lint:
  extends:
    - .nodejs_image
    - .nodejs_cache
  stage: test
  needs:
    - job: nodejs:build
      artifacts: true
  tags:
    - lightweight-job
  script:
    - npm run lint --if-present
  rules:
    - <<: *skip_code_quality_disabled
    - <<: *skip_if_makefile
    - <<: *nodejs_present_rule

nodejs:test:
  extends:
    - .nodejs_image
    - .nodejs_cache
  stage: test
  needs:
    - job: nodejs:build
      artifacts: true
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  tags:
    - lightweight-job
  script:
    - npm test --if-present
  rules:
    - <<: *skip_test_disabled
    - <<: *skip_if_makefile
    - <<: *nodejs_present_rule

nodejs:test:e2e:
  extends:
    - .nodejs_image_browsers
    - .nodejs_cache
  stage: test
  needs:
    - job: nodejs:build
      artifacts: true
  tags:
    - heavy-job
  script:
    - npm run test:e2e --if-present
  rules:
    - <<: *skip_test_system_disabled
    - <<: *skip_if_makefile
    - <<: *nodejs_present_rule
